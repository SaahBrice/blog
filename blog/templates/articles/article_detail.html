{% extends "base.html" %}
{% load static %}
{% load article_tags %}

<link rel="stylesheet" href="{% static 'css/reaction.css' %}">

{% block content %}
<h2>{{ article.title }}</h2>
<p>Author: {{ article.author.username }}
    {% if article.author.is_verified %}
        <span class="badge">Verified</span>
    {% endif %}
    {% if article.author.is_premium %}
        <span class="badge">Premium</span>
    {% endif %}
    {% if article.author.is_writer %}
        <span class="badge">Writer</span>
    {% endif %}</p>
<p>Published: {{ article.published_at }}</p>

<p>Tags: {% for tag in article.tags.all %}
    <a href="{% url 'article_by_tag' tag.slug %}">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
{% endfor %}</p>
<div>{{ article.content }}</div>

{% if user == article.author %}
    <a href="{% url 'article_update' article.pk %}">Edit Article</a>
{% endif %}

<h3>Comments ({{ article.comment_count }})</h3>
{% for comment in article.comments.all %}
    {% if not comment.parent %}
        <div class="comment">
            <p>{{ comment.content }}</p>
            <small>By {{ comment.author.username }} on {{ comment.created_at }}</small>

            <div class="comment-reactions" data-comment-id="{{ comment.id }}">
                {% for reaction_type in "clap,laugh,sad"|split:"," %}
                    <div class="comment-reaction-container">
                        <button class="comment-reaction" data-type="{{ reaction_type }}" data-comment-id="{{ comment.id }}">
                            {% if reaction_type == "clap" %}üëè
                            {% elif reaction_type == "laugh" %}üòÇ
                            {% elif reaction_type == "sad" %}üò¢
                            {% endif %}
                            <span class="{{ reaction_type }}-count">{{ comment|get_comment_reaction_count:reaction_type }}</span>
                        </button>
                        <div class="reaction-options" style="display:none;">
                            <button class="comment-reaction-amount" data-amount="10">+10</button>
                            <button class="comment-reaction-amount" data-amount="50">+50</button>
                            <button class="comment-reaction-amount" data-amount="100">+100</button>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="replies" style="margin-left: 20px;">
                {% for reply in comment.replies.all %}
                    <div class="reply">
                        <p>{{ reply.content }}</p>
                        <small>By {{ reply.author.username }} on {{ reply.created_at }}</small>
                        <div class="comment-reactions">
                            <button class="comment-reaction" data-type="clap" data-comment-id="{{ reply.id }}">
                                üëè (<span class="clap-count">{{ reply.clap_count }}</span>)
                            </button>
                            <button class="comment-reaction" data-type="laugh" data-comment-id="{{ reply.id }}">
                                üòÇ (<span class="laugh-count">{{ reply.laugh_count }}</span>)
                            </button>
                            <button class="comment-reaction" data-type="sad" data-comment-id="{{ reply.id }}">
                                üò¢ (<span class="sad-count">{{ reply.sad_count }}</span>)
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <form method="post" action="{% url 'add_reply' comment.id %}" class="reply-form">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Write a reply...">
                <button type="submit">Reply</button>
            </form>
        </div>
    {% endif %}
{% empty %}
    <p>No comments yet.</p>
{% endfor %}

{% if user.is_authenticated %}
    <button id="followAuthorBtn" data-author-id="{{ article.author.id }}">
        {% if is_following %}Unfollow{% else %}Follow{% endif %} Author
    </button>
    <button id="bookmarkBtn" data-article-id="{{ article.id }}">
        {% if is_bookmarked %}Remove Bookmark{% else %}Bookmark{% endif %}
    </button>
    <div class="reactions">
        {% for reaction_type in "clap,sad,laugh"|split:"," %}
            <div class="reaction-container">
                <button class="reaction-btn" data-type="{{ reaction_type }}" data-article-id="{{ article.id }}">
                    {% if reaction_type == "clap" %}üëè
                    {% elif reaction_type == "sad" %}üò¢
                    {% elif reaction_type == "laugh" %}üòÇ
                    {% endif %}
                    <span id="{{ reaction_type }}-count">{{ article|get_reaction_count:reaction_type }}</span>
                </button>
                <div class="reaction-options" style="display:none;">
                    <button class="reaction-amount" data-amount="10">+10</button>
                    <button class="reaction-amount" data-amount="50">+50</button>
                    <button class="reaction-amount" data-amount="100">+100</button>
                </div>
            </div>
        {% endfor %}
    </div>
    <h4>Add a comment</h4>
    <form method="post" action="{% url 'comment_create' article.pk %}">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit">Submit Comment</button>
    </form>
{% else %}
    <p>Please <a href="{% url 'account_login' %}">log in</a> to comment.</p>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/article_detail.js' %}"></script>
{% endblock %}