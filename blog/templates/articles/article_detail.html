{% extends "base.html" %}
{% load static %}
{% load article_tags %}
{% load comment_tags %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reaction.css' %}">
<link rel="stylesheet" href="{% static 'css/tribute.css' %}">
<link rel="stylesheet" href="{% static 'css/mentions.css' %}">
{% endblock %}
</head>

{% block content %}
<h2>{{ article.title }}</h2>
<p>Author: {{ article.author.username }}
    {% if article.author.is_verified %}
        <span class="badge">Verified</span>
    {% endif %}
    {% if article.author.is_premium %}
        <span class="badge">Premium</span>
    {% endif %}
    {% if article.author.is_writer %}
        <span class="badge">Writer</span>
    {% endif %}</p>
<p>Published: {{ article.published_at }}</p>

<p>Tags: {% for tag in article.tags.all %}
    <a href="{% url 'article_by_tag' tag.slug %}">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
{% endfor %}</p>
<div id="article-content">
    {% with content_html=article.get_content_as_html %}
        {% if content_html %}
            {{ content_html|safe }}
        {% else %}
            <p>{{ article.content }}</p>
        {% endif %}
    {% endwith %}
</div>


<button id="ttsButton">Read Article</button>
<input type="hidden" id="speechify-api-key" value="{{ speechify_api_key }}">



{% if user == article.author %}
    <a href="{% url 'article_update' article.pk %}">Edit Article</a>
{% endif %}



<h3>Comments (<span id="comment-count">{{ article.comment_count }}</span>)</h3>
<div id="comments-section">
{% for comment in article.comments.all %}
    {% if not comment.parent %}
        {% include "articles/comment.html" with comment=comment %}
    {% endif %}
{% empty %}
    <p>No comments yet.</p>
{% endfor %}
</div>





{% if user.is_authenticated %}
    <button id="followAuthorBtn" data-author-id="{{ article.author.id }}">
        {% if is_following %}Unfollow{% else %}Follow{% endif %} Author
    </button>
    <button id="bookmarkBtn" data-article-id="{{ article.id }}">
        {% if is_bookmarked %}Remove Bookmark{% else %}Bookmark{% endif %}
    </button>
    <div class="reactions">
        {% for reaction_type in "clap,sad,laugh"|split:"," %}
            <div class="reaction-container">
                <button class="reaction-btn" data-type="{{ reaction_type }}" data-article-id="{{ article.id }}">
                    {% if reaction_type == "clap" %}üëè
                    {% elif reaction_type == "sad" %}üò¢
                    {% elif reaction_type == "laugh" %}üòÇ
                    {% endif %}
                    <span id="{{ reaction_type }}-count">{{ article|get_reaction_count:reaction_type }}</span>
                </button>
                <div class="reaction-options" style="display:none;">
                    <button class="reaction-amount" data-amount="10">+10</button>
                    <button class="reaction-amount" data-amount="50">+50</button>
                    <button class="reaction-amount" data-amount="100">+100</button>
                </div>
            </div>
        {% endfor %}
    </div>
    <h4>Add a comment</h4>
    <form method="post" action="{% url 'comment_create' article.pk %}" id="comment-form">
        {% csrf_token %}
        {{ comment_form.content }}
        <div id="mention-autocomplete"></div>
        <button type="submit">Submit Comment</button>
    </form>
{% else %}
    <p>Please <a href="{% url 'account_login' %}">log in</a> to comment.</p>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/article_detail.js' %}"></script>
<script src="{% static 'js/tribute.js' %}"></script>
<script src="{% static 'js/text-to-speech.js' %}"></script>
{% endblock %}